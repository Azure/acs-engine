version: 2
jobs:
  test:
    working_directory: /go/src/github.com/Azure/acs-engine
    docker:
      - image: microsoft/acs-engine:latest
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: make bootstrap
      - run:
          name: Run style and unit tests
          command: make test-style build test
      - run:
          name: Generate test coverage results
          command:  make build coverage
  e2e:
    working_directory: /go/src/github.com/Azure/acs-engine
    docker:
      - image: microsoft/acs-engine:latest
        environment:
          BUILD_NUMBER: $CIRCLE_BUILD_NUM
          RESOURCE_GROUP_PREFIX: y
          SKIP_METRICS: y
          STAGE_TIMEOUT_MIN: 30
          NUM_OF_RETRIES: 2
          TEST_CONFIG: test/acse-conf/acse-pr.json
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: make bootstrap
      - run:
          name: e2e tests
          command: make build test-e2e

workflows:
  version: 2
  build_and_test:
    jobs:
      - test
      - e2e-hold:
          type: approval
          requires:
            - test
      - e2e:
          requires:
            - e2e-hold
